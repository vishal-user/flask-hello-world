node {
    try {
        // Define environment variables
        def venv = 'venv'
        def appFile = 'app.py'

        stage('Checkout') {
              steps {
                  git branch: 'main' , url:'https://github.com/vishal-user/flask-hello-world.git'
              }
        }

        stage('Setup Python Environment') {
            // Set up Python virtual environment and install dependencies
            sh """
                python3 -m venv ${venv}
                source ${venv}/bin/activate
                pip install --upgrade pip
                pip install flask
            """
        }

        stage('Run Flask App') {
            // Run the Flask application
            sh """
                source ${venv}/bin/activate
                nohup python ${appFile} &
            """
        }
    } catch (Exception e) {
        currentBuild.result = 'FAILURE'
        throw e
    } finally {
        // Clean up: Terminate Flask application and deactivate virtual environment
        echo 'Cleaning upâ€¦'
        sh 'pkill -f "python app.py" || true'
        sh 'deactivate || true'
    }
}

